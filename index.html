<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LiPo Safe</title>
    <link rel="stylesheet" href="./bulma.css">
    <link rel="stylesheet" href="./swatch.min.css">
    <link rel="stylesheet" href="./main.css">

    <script src="./localforage.js"></script>
    <script src="./jquery.js"></script>
</head>

<body>
    <a role="button" id="burger" class="navbar-burger" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <aside class="menu navbar-menu" data-active="false" id="menu">
        <!-- condensed this to for loop -->
    </aside>
    <section id="calc" class="section">
        <div class="columns is-flex is-vcentered is-centered">
            <div class="box column is-two-thirds is-half-tablet">
                <div class="select is-primary">
                    <select id="chem" data-chem="lipo" data-cellVoltage="4.2">
                        <option>LiPo</option>
                        <option>LiHv</option>
                    </select>
                </div>
                <input id="cells" class="input" type="number" placeholder="How many cells (S value)">
                <input id="mah" class="input" type="number" placeholder="Battery cap (in mAh)">
                <div>
                    <label>Min voltage:</label>
                    <span id="minVolt"></span>
                </div>
                <div>
                    <label>Max voltage:</label>
                    <span id="maxVolt"></span>
                </div>
                <div>
                    <label>Storage voltage:</label>
                    <span id="storVolt"></span>
                </div>
                <div>
                    <label>Charge Rate (in A):</label>
                    <span id="chargeRate"></span>
                </div>
            </div>
        </div>
    </section>
    <section id="batteryManagement" class="section">
        <div class="columns is-flex is-vcentered is-centered">
            <div class="box column is-two-thirds is-half-tablet" id="bmNew">
                <h3>Add new battery</h3>
                <div class="select is-primary">
                    <select id="chemBM" data-chem="lipo">
                        <option>LiPo</option>
                        <option>LiHv</option>
                    </select>
                </div>
                <input id="cellsBM" class="input" type="number" placeholder="How many cells (S value)">
                <input id="mahBM" class="input" type="number" placeholder="Battery cap (in mAh)">
                <input id="nameBM" class="input" type="text" placeholder="Battery name">
                <input id="battDateBM" class="input" type="date" placeholder="Bought Date">
                <input id="initiallIrBM" class="input" type="number" placeholder="Initial Internal Resistance">
                <button class="button" id="saveBattery">Save Battery</button>
                <button class="button" id="updateBattery" data-id="">Update Battery</button>
            </div>
        </div>
        <div class="columns is-flex is-vcentered is-centered">
            <div id="savedBatteriesDisplay" class="box column is-two-thirds is-half-tablet">

            </div>
        </div>
    </section>
    <section id="credits" class="section">
        <p class="columns is-flex is-vcentered is-centered">Hate ads? So do we, keep our app free by donating a cup of
            coffee to the devs.</p>
        <div class="tile is-ancestor columns is-flex is-vcentered is-centered">
            <div class="tile is-vertical is-8">
                <div class="tile">
                    <div class="tile is-parent">
                        <article class="tile is-child notification is-info">
                            <p class="title">Michael LaPan</p>
                            <p class="subtitle">UI/UX/Calculator</p>
                            <a href="https://www.buymeacoffee.com/michaellapan">
                                <figure class="image is-4by2">
                                    <img href="https://www.buymeacoffee.com/michaellapan"
                                        src="https://img.buymeacoffee.com/api/?url=aHR0cHM6Ly9pbWcuYnV5bWVhY29mZmVlLmNvbS9hcGkvP25hbWU9bWljaGFlbGxhcGFuJnNpemU9MzAwJmJnLWltYWdlPWJtYyZiYWNrZ3JvdW5kPQ==&creator=michaellapan&design_code=1&design_color=%23BD5FFF&slug=michaellapan">
                                </figure>
                            </a>
                        </article>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section id="models" class="section">
        <p class="columns is-flex is-vcentered is-centered">Hate ads? So do we, keep our app free by donating a cup of
            coffee to the devs.</p>
        <div class="tile is-ancestor columns is-flex is-vcentered is-centered">
            <div class="tile is-vertical is-8">
                <div class="tile">
                    <div class="tile is-parent">
                        <article class="tile is-child notification is-info">
                            <p class="title">Michael LaPan</p>
                            <p class="subtitle">UI/UX/Calculator</p>
                            <a href="https://www.buymeacoffee.com/michaellapan">
                                <figure class="image is-4by2">
                                    <img href="https://www.buymeacoffee.com/michaellapan"
                                        src="https://img.buymeacoffee.com/api/?url=aHR0cHM6Ly9pbWcuYnV5bWVhY29mZmVlLmNvbS9hcGkvP25hbWU9bWljaGFlbGxhcGFuJnNpemU9MzAwJmJnLWltYWdlPWJtYyZiYWNrZ3JvdW5kPQ==&creator=michaellapan&design_code=1&design_color=%23BD5FFF&slug=michaellapan">
                                </figure>
                            </a>
                        </article>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section id="saftey" class="section">
        <div class="card">
            <header class="card-header">
                <p class="card-header-title">
                    Battery Charging
                </p>
            </header>
            <div class="card-content">
                <div class="content">
                    <p>LiPos should never be charged above 4.2 per cell.</p>
                    <p>LiHv should never be charged above 4.25 per cell.</p>
                    <p>charging past that can damage individual cells and can cause a fire.</p>
                    <p>LiPos should never be discharged past 3.2 per cell. Its safest to land at 3.5</p>
                    <p>LiPos should never be left at full charge for multiple days. It both degrades the battery and is
                        a fire hazzard</p>
                    <p>When not in use LiPos should be stored at/around 3.8 per cell</p>
                    <p>LiPos should be stored in a LiPo bag when not in use</p>
                </div>
            </div>
        </div>
    </section>
    <script>
        $(document).ready(function () {

            let menuArry = [
                { id: "batteryManagementLink", text: "Battery Management" },
                { id: "calcLink", text: "Calculator" },
                { id: "safteyLink", text: "Safety Info" },
                { id: "creditsLink", text: "Credits" },
                { id: "modelsLink", text: "Models" }
            ];

            //adds in menu items
            for (let index = 0; index < menuArry.length; index++) {
                let ulEL = $("<ul>")
                    .addClass("menu-list")
                    .attr("id", menuArry[index].id);
                let liEl = $("<li>");
                let aEl = $("<a>").text(menuArry[index].text);
                liEl.append(aEl)
                ulEL.append(liEl);
                $("#menu").append(ulEL);
            }

            hideAllShowOne("calc");

            function clearBatts(){
                $("#savedBatteriesDisplay").empty();
            }

            hideAllShowOne("batteryManagement");
            $("#burger").click(function () {
                $("#menu").data("active", !$("#menu").data('active'));
                $("#menu").toggleClass('is-active');
            });

            $("#updateBattery").click(function () {
                let idToFind = $(this).data("id");
                localforage.getItem('savedBatteries').then(function(value) {
                    let savedBatteriesToSave = [];
                    // This code runs once the value has been loaded
                    // from the offline store.
                    if(value !== null){
                        value.forEach(element => {
                            if(element.id == idToFind){
                                savedBatteriesToSave.push(getBattData(true, idToFind))
                            } else {
                                savedBatteriesToSave.push(element)
                            }
                        });
                    }
                    clearBatts();
                    setBattData(savedBatteriesToSave);

                    $("#updateBattery").hide();
                    $("#saveBattery").show();
                }).catch(function(err) {
                    // This code runs if there were any errors
                    console.log(err);
                });    
            });

            $("#chem").on('change', function (e) {
                $("#chem").data("chem", e.target.value)
                if (e.target.value == "LiPo") {
                    $("#chem").data("cellvoltage", 4.2)
                } else {
                    $("#chem").data("cellvoltage", 4.35)
                }
                populateBattInfo();
            })

            $("#cells").on('input', function (e) {
                populateBattInfo();
            });

            $("#mah").on('input', function (e) {
                populateBattInfo();
            });

            function populateBattInfo() {
                let cells = parseFloat($("#cells").val());
                if (!isNaN(cells)) {
                    $("#chargeRate").text(toTwo(parseFloat($("#mah").val()) / 1000))
                    $("#minVolt").text(toTwo(3.5 * parseFloat($("#cells").val())))
                    $("#maxVolt").text(toTwo(parseFloat($("#chem").data("cellvoltage")) * parseFloat($("#cells").val())))
                    $("#storVolt").text(toTwo(parseFloat($("#cells").val()) * 3.80))
                }
            }

            function toTwo(num) {
                return Math.round((num + Number.EPSILON) * 100) / 100
            }

            function hideAllShowOne(idOfOneToShow) {
                $("#calc").hide();
                $("#batteryManagement").hide();
                $("#credits").hide();
                $("#saftey").hide();
                $("#models").hide();
                $("#" + idOfOneToShow).show();
            }

            let savedBatteries = [];
            getSavedBatts();
            function getSavedBatts(){
                localforage.getItem('savedBatteries').then(function(value) {
                
                    savedBatteries = value;
                    console.log(savedBatteries)

                }).catch(function(err) {
                    // This code runs if there were any errors
                    console.log(err);
                });   
            }
            function getAndLoadSavedBatts(){
                localforage.getItem('savedBatteries').then(function(value) {
                    // This code runs once the value has been loaded
                    // from the offline store.
                    if(value !== null){
                        value.forEach(element => {
                            let outterDiv = $("<div>", {"class": "card"});
                            let innerDiv = $("<div>", {"class": "card-content"});
                            let mediaDiv = $("<div>", {"class": "media"});
                            let mediaContentDiv = $("<div>", {"class": "media-content"});
                            let mediaContentPDiv = $("<p>", {"class": "title is-4"}).text(element.name);
                            let content = $("<div>", {"class": "content"});
                            let contentPBattInfo = $("<p>", {"class": "title is-4"}).text(element.cells + "s " + element.chem + " | " + element.mah + "mAh");
                            let editButton = $("<button>", {id: "savedBatteryEdit", "class": "button", "data-id": element.id}).text("EDIT");
                            
                            content.prepend(editButton);
                            content.prepend(contentPBattInfo);
                            innerDiv.prepend(content);

                            mediaContentDiv.prepend(mediaContentPDiv)
                            innerDiv.prepend(mediaContentDiv)

                            outterDiv.prepend(innerDiv);
                            $("#savedBatteriesDisplay").prepend(outterDiv)
                        });
                        $("#savedBatteryEdit").click(function () {
                            $("#updateBattery").show();
                            $("#saveBattery").hide();
                            $("#updateBattery").data("id", $(this).data("id"));

                            let foundBatt = savedBatteries[$(this).data("id") - 1];

                            $("#chemBM").val(foundBatt.chem);
                            $("#cellsBM").val(foundBatt.cells);
                            $("#mahBM").val(foundBatt.mah);
                            $("#nameBM").val(foundBatt.name);
                            $("#battDateBM").val(foundBatt.battDate);
                            $("#initiallIrBM").val(foundBatt.initiallIr);
                        });
                    }

                }).catch(function(err) {
                    // This code runs if there were any errors
                    console.log(err);
                });                
            }

            getAndLoadSavedBatts();
            //menu system
            $("ul").click(function () {
                hideAllShowOne($(this).attr("id").replace("Link", ""));
            })

            //battery management logic

            function getBattData(update, id){
                let battToSave = {};
                $("#bmNew").find("input").each(function(){
                    battToSave[this.id.replace('BM', '')] = this.value;
                    this.value = '';
                })
                if(!update){
                    battToSave.id = savedBatteries.length + 1
                } else {
                    battToSave.id = id;
                }
                battToSave.chem = $("#chemBM").val();
                return battToSave;
            }


            function setBattData(dataToSet){
                localforage.setItem('savedBatteries', dataToSet).then(function(value) {
                    // This will output `1`.
                    console.log(value[0]);
                    getAndLoadSavedBatts();
                }).catch(function(err) {
                    // This code runs if there were any errors
                    console.log(err);
                });
            }
            //get data from inputs and plop it into the savedBatt array
            $("#saveBattery").click(function(){
                if(savedBatteries === null){
                    savedBatteries = []
                }
                savedBatteries.push(getBattData());
                setBattData(savedBatteries)
            });
            $("#updateBattery").hide();
        });
    </script>
</body>

</html>